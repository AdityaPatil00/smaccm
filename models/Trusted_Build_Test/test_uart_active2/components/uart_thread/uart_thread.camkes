import "../../interfaces/uart_thread_interface.idl4";
import "../../interfaces/test_uart__uart_packet_i_writer.idl4";
import "../../interfaces/uart.idl4"; 

component uartbase {
  hardware;
  dataport Buf mem;
  emits DataAvailable irq;
}

component uart_thread {
  control;

  include "smaccm_wrapper_i_types.h";
  provides test_uart__uart_packet_i_writer input; 
  has mutex smaccm_uart_thread_input_mut; 
	
  provides uart_inf       uart;
  dataport Buf            uart0base;
  consumes DataAvailable  interrupt;
  has semaphore           read_sem;
  has semaphore           write_sem;
  attribute int           ID;
}

assembly {
  composition {
    component uartbase uartbase_comm1;
    
    /* UART hardware connection */
    connection seL4HardwareMMIO uartbase_mem(from uart_thread_inst.uart0base, to uartbase_comm1.mem);
    connection seL4HardwareInterrupt uartbase_irq(from uartbase_comm1.irq, to uart_thread_inst.interrupt);
  }
  
  configuration {
    // GPS on daughterboard (unconfirmed)
    // uartbase_comm1.mem_attributes = "0x12C30000:0x1000";
    // uartbase_comm1.irq_attributes = 86;

    // Telem on daughterboard (Ihor says UART #3 but the memory address is UART #1)
    uartbase_comm1.mem_attributes = "0x12C10000:0x1000";
    uartbase_comm1.irq_attributes = 84;

    // UART #2 - Serial console on ODROID-XU
    // uartbase_comm1.mem_attributes = "0x12C20000:0x1000";
    // uartbase_comm1.irq_attributes = 85;

    // UART #0 - LIDAR on daughterboard (unconfirmed)
    // uartbase_comm1.mem_attributes = "0x12C00000:0x1000";
    // uartbase_comm1.irq_attributes = 83;

    /**
     From libs/libplatsupport/plat_include/exynos5/platsupport/plat/serial.h
     #define EXYNOS_UART0_PADDR  0x12C00000
     #define EXYNOS_UART1_PADDR  0x12C10000
     #define EXYNOS_UART2_PADDR  0x12C20000
     #define EXYNOS_UART3_PADDR  0x12C30000
    
     #define EXYNOS_UART0_IRQ    83
     #define EXYNOS_UART1_IRQ    84
     #define EXYNOS_UART2_IRQ    85
     #define EXYNOS_UART3_IRQ    86
     */

    uart_thread_inst.ID = 1;
  }
}
